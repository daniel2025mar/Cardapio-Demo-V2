<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Ativar Mesa</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9fafb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .box {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .ok { color: #16a34a; font-weight: bold; }
    .erro { color: #dc2626; font-weight: bold; }
  </style>
</head>
<body>

<div class="box">
  <h2 id="msg">Verificando mesa...</h2>
  <p id="submsg">Aguarde um instante</p>
</div>

<script>
  // =========================
  // SUPABASE
  // =========================
  const SUPABASE_URL = "https://jvxxueyvvgqakbnclgoe.supabase.co";
  const SUPABASE_KEY = "SUA_ANON_KEY_AQUI";

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  const msg = document.getElementById("msg");
  const submsg = document.getElementById("submsg");

  // =========================
  // PEGAR N√öMERO DA MESA
  // =========================
  const params = new URLSearchParams(window.location.search);
  const numeroMesa = params.get("mesa");

  console.log("Mesa recebida:", numeroMesa);

  if (!numeroMesa) {
    msg.innerText = "Mesa n√£o informada ‚ùå";
    msg.className = "erro";
    submsg.innerText = "";
  } else {
    verificarMesa();
  }

  async function verificarMesa() {
    try {
      const { data: mesa, error } = await supabaseClient
        .from("mesas")
        .select("id, numero, cliente_presente")
        .eq("numero", numeroMesa)
        .single();

      if (error || !mesa) {
        msg.innerText = "Mesa n√£o encontrada ‚ùå";
        msg.className = "erro";
        submsg.innerText = "";
        return;
      }

      // J√° ativa
      if (mesa.cliente_presente === true) {
        msg.innerText = `Mesa ${mesa.numero} j√° est√° ativa ‚úÖ`;
        msg.className = "ok";
        submsg.innerText = "Aguarde o atendimento üçΩÔ∏è";
        return;
      }

      // Ativar mesa
      const { error: erroUpdate } = await supabaseClient
        .from("mesas")
        .update({
          cliente_presente: true,
          ativo: true
        })
        .eq("id", mesa.id);

      if (erroUpdate) throw erroUpdate;

      msg.innerText = `Mesa ${mesa.numero} ativada com sucesso ‚úÖ`;
      msg.className = "ok";
      submsg.innerText = "Aguarde o atendimento üçΩÔ∏è";

    } catch (err) {
      console.error(err);
      msg.innerText = "Erro ao ativar mesa ‚ùå";
      msg.className = "erro";
      submsg.innerText = "Chame um atendente.";
    }
  }
</script>

</body>
</html>
