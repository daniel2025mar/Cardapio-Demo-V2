<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Ativar Mesa</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9fafb;
      text-align: center;
      padding: 80px 20px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    p {
      font-size: 16px;
    }

    .ativo {
      color: #16a34a;
      font-weight: bold;
    }

    .erro {
      color: #dc2626;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1 id="msg">Verificando mesa...</h1>
  <p id="submsg">Aguarde um instante</p>

  <script>
    // =========================
    // CONFIGURA√á√ÉO SUPABASE
    // =========================
    const SUPABASE_URL = "https://jvxxueyvvgqakbnclgoe.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp2eHh1ZXl2dmdxYWtibmNsZ29lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMjM3MzYsImV4cCI6MjA3OTU5OTczNn0.zx8i4hKRBq41uEEBI6s-Z70RyOVlvYz0G4IMgnemT3E";

    const supabase = window.supabase.createClient(
      SUPABASE_URL,
      SUPABASE_KEY
    );

    const msg = document.getElementById("msg");
    const submsg = document.getElementById("submsg");

    // =========================
    // PEGA O N√öMERO DA MESA DO QR
    // =========================
    const params = new URLSearchParams(window.location.search);
    const numeroMesa = params.get("mesa");

    if (!numeroMesa) {
      msg.innerText = "Mesa n√£o informada ‚ùå";
      submsg.innerText = "QR Code inv√°lido.";
      msg.className = "erro";
    } else {
      ativarMesa(numeroMesa);
    }

    // =========================
    // VERIFICA E ATIVA A MESA
    // =========================
    async function ativarMesa(numero) {
      try {
        // 1Ô∏è‚É£ BUSCAR MESA PELO N√öMERO
        const { data: mesa, error } = await supabase
          .from("mesas")
          .select("id, numero, cliente_presente")
          .eq("numero", numero)
          .single();

        if (error || !mesa) {
          msg.innerText = "Mesa n√£o encontrada ‚ùå";
          submsg.innerText = "Chame um atendente.";
          msg.className = "erro";
          return;
        }

        // 2Ô∏è‚É£ SE J√Å ESTIVER ATIVA
        if (mesa.cliente_presente === true) {
          msg.innerText = `Mesa ${mesa.numero} j√° est√° ativa ‚úÖ`;
          submsg.innerText = "Aguarde o atendimento üçΩÔ∏è";
          msg.className = "ativo";
          return;
        }

        // 3Ô∏è‚É£ ATIVAR MESA
        const { error: erroUpdate } = await supabase
          .from("mesas")
          .update({
            cliente_presente: true,
            ativo: true
          })
          .eq("id", mesa.id);

        if (erroUpdate) throw erroUpdate;

        msg.innerText = `Mesa ${mesa.numero} ativada com sucesso ‚úÖ`;
        submsg.innerText = "Aguarde o atendimento üçΩÔ∏è";
        msg.className = "ativo";

      } catch (err) {
        console.error(err);
        msg.innerText = "Erro ao ativar mesa ‚ùå";
        submsg.innerText = "Chame um atendente.";
        msg.className = "erro";
      }
    }
  </script>

</body>
</html>
